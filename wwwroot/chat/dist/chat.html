<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>chat room demo</title>
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <script src="http://7u2sas.com1.z0.glb.clouddn.com/js/jquery.1.8.3.min.js"></script>
    <script src="js/bmobSocketIo.js"></script>
    <script src="js/bmob.js"></script>
    <script type="text/javascript" src="js/jquery.qqFace.js"></script>
</head>
<body>
    <h1>chat room demo</h1>
    <div class="msg-box clearfix">
      <span>欢迎你，<span class="col-red" id="current"></span></span>
      <a href="javascript:;" id="reg" class="fr">注销</a>
    </div>
    <div id="data" class="clearfix chat"></div>
    <div class="btn-box">
        <textarea class="content" id="content" name="content"></textarea>
        <span class="emotion">表情</span>
        <a href="javascript:;" class="send-btn" id="send">发送</a>
    </div>  
    <div class="login-box">
      <h3>请输入本次昵称：(不超过5个字)</h3>
      <ul>
        <li><input type="text" class="name" id="name"></li>
        <li><a href="javascript:;" class="sure" id="sure">确定</a></li>
      </ul>
    </div>
    <div class="full-bg">
    </div>
  <script type="text/javascript" src="js/iNotify.js"></script>
  <script type="text/javascript">

  var hidden,visibilityChange;
  if (typeof document.hidden !== "undefined") { // Opera 12.10 and Firefox 18 and later support 
    hidden = "hidden";
    visibilityChange = "visibilitychange";
  } else if (typeof document.mozHidden !== "undefined") {
    hidden = "mozHidden";
    visibilityChange = "mozvisibilitychange";
  } else if (typeof document.msHidden !== "undefined") {
    hidden = "msHidden";
    visibilityChange = "msvisibilitychange";
  } else if (typeof document.webkitHidden !== "undefined") {
    hidden = "webkitHidden";
    visibilityChange = "webkitvisibilitychange";
  }
var iNotify = new iNotify().init({
    message: '有消息了。',//标题 
    effect: 'flash', // flash | scroll 闪烁还是滚动 
    //可选播放声音 
  
    //标题闪烁，或者滚动速度 
    interval: 1000,
    //可选，默认绿底白字的  Favicon 
    updateFavicon:{
        // favicon 字体颜色 
        textColor: "#fff",
        //背景颜色，设置背景颜色透明，将值设置为“transparent” 
        backgroundColor: "#000" 
    },
    //可选chrome浏览器通知，默认不填写就是下面的内容 
    notification:{
        title:"Miko的聊天室通知！",//设置标题 
        icon:"/images/icon.png",//设置图标 icon 默认为 Favicon 
        body: '你好！'+localStorage.name + '，你有新消息！'//设置消息内容 
    }
})
iNotify.setFavicon("M");

    $(document).ready(function(){
      if(localStorage.name){
        $(".login-box,.full-bg").css("display","none");
      }
      $("#sure").on("click",function(){
        localStorage.name = $("#name").val()
        $(".login-box,.full-bg").css("display","none");
        $("#current").text(localStorage.name);
      })
      $("#current").text(localStorage.name);
      $("#reg").on("click",function(){
        $(".login-box,.full-bg").css("display","block");
      })
      $('.emotion').qqFace({
        id : 'facebox', //表情盒子的ID
        assign:'content', //给那个控件赋值
        path:'face/'  //表情存放的路径
      });
    })
    var title = $("title").text(),blink;
    function sendMsg(){
        var name= localStorage.name;
        var content = $("#content").val();
         if($.trim(content)==""){
            alert("内容不能为空！");
            return;
        }       
        var Chat = Bmob.Object.extend("Chat");
        var chat = new Chat();
        chat.set("name", localStorage.name);
        chat.set("content", $("#content").val());
        chat.save(null, {
          success: function(object) {           
          },
          error: function(model, error) {            
          }
        });    
        $("#content").val(""); 
    }
    $("#send").click(function(){
        sendMsg();
    });
    function replace_em(str){
      str = str.replace(/\</g,'&lt;');
      str = str.replace(/\>/g,'&gt;');
      str = str.replace(/\n/g,'<br/>');
      str = str.replace(/\[em_([0-9]*)\]/g,'<img src="face/$1.gif" border="0" />');
      return str;
    }
    //服务器
    BmobSocketIo.initialize("b5858b7b2f1704c0db5d549a2cf48e14");
    Bmob.initialize("b5858b7b2f1704c0db5d549a2cf48e14", "7666c915d7c46a928d547a7898507c4e");
   //初始连接socket.io服务器后，需要监听的事件都写在这个函数内
    BmobSocketIo.onInitListen = function() {
      //订阅GameScore表的数据更新事件
      BmobSocketIo.updateTable("Chat");     
    };
      //监听服务器返回的更新表的数据
   BmobSocketIo.onUpdateTable = function(tablename,data) {    
     if( tablename=="Chat" ) {
        // alert(tablename);
        var content=$("#data");
        if(data.name == localStorage.name){
          var p = '<p class="chat-box-r"><span style="color:red;">' + data.name+'</span>  '+'<span style="color:green;">'+ data.createdAt+'</span>  '+ ' :<br/> '+replace_em(data.content)+'</p><br/><br/>';
        }else{
          var p = '<p class="chat-box-l"><span style="color:red;">' + data.name+'</span>  '+'<span style="color:green;">'+ data.createdAt+'</span>  '+ ' :<br/> '+replace_em(data.content)+'</p><br/><br/>';
          if(document[hidden]){
            iNotify.notify(true)
          }
        }
        content.html(content.html()+p);
        var top = $("#data")[0].scrollHeight
        $("#data").scrollTop(top);
     }
   };
  //通过“回车”提交聊天信息
  $('#content').keydown(function(e) {
    if (e.keyCode === 13) {
      e.preventDefault();
      sendMsg();
    }
  });
  </script>
</body>
</html>
